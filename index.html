<!DOCTYPE html>
<html>

<head>
  <title>AMQ Listening</title>
  <meta charset='utf-8'/>
  <script src="data.js"></script>
    <script>
// this dumb bit of "encryption" is not meant to keep a determined individual
// from getting the links stored here, since it is fairly simple to crack
// however, it is enough to keep any basic web crawler from picking them up
const amq_scramble = {};

amq_scramble.hosts = {
  "catbox": "https://files.catbox.moe",
  "track9": "https://track9.mixtape.moe",
  "themes": "https://animethemes.moe",
  "openings": "https://openings.moe",
};
amq_scramble.decode_link_obj = function(link_obj, password) {
  let link = amq_scramble.hosts[link_obj.host] + '/';
  for(let i = 0; i < link_obj.code.length; i++) {
    link += String.fromCharCode(link_obj.code[i] ^ password.charCodeAt(i % password.length)); //fun
  };
  return link + '.' + link_obj.ext;
};
amq_scramble.parse_link_string = function(link_string) {
  let semi_split = link_string.split(';');
  return {
    host: semi_split[0],
    code: semi_split[1].split(',').map(x => parseInt(x)),
    ext:  semi_split[2],
  };
};
amq_scramble.decode = function(link_string, password) {
  return amq_scramble.decode_link_obj(amq_scramble.parse_link_string(link_string), password);
};

let cur_song = 0;
let cur_group = 'Ongaku Shoujo';
let quality = 'mp3';
let player = undefined;
let desc = undefined;
let anime_select = undefined;
let quality_select = undefined;
let song_select = undefined;
let password = '';

const play_song = function(index) {
  cur_song = index;
  song_select.selectedIndex = index;
  player.src = amq_scramble.decode(data[cur_group][cur_song][quality], password);
  player.innerHTML = data[cur_group][cur_song].desc;
  desc.innerHTML = data[cur_group][cur_song].desc;
};

const play_next = function() {
  play_song((cur_song + 1) % data[cur_group].length);
};

const play_group = function(group) {
  cur_group = group;
  cur_song = 0;

  song_select.options.length = 0;

  data[cur_group].forEach(
    function (val, idx) {
      let opt = document.createElement('option');
      opt.value = idx;
      opt.innerHTML = val.desc;
      song_select.appendChild(opt);
    }
  );
  song_select.size = Math.min(10, song_select.options.length);

  play_song(cur_song);
};

const set_quality = function(q) {
  quality = q;
  play_song(cur_song);
};

const start = function() {
  desc = document.getElementById('desc');
  password = document.getElementById('password_input').value;
  next_button = document.getElementById('next_button');
  anime_select = document.getElementById('anime_select');
  song_select = document.getElementById('song_select');
  quality_select = document.getElementById('quality_select');
  mobile_checkbox = document.getElementById('mobile_checkbox');
  mobile = mobile_checkbox.checked;

  player = document.getElementById('player');
  player.addEventListener('ended', function() {
    play_next();
  });

  document.getElementById('password_input').remove();
  document.getElementById('password_label').remove();
  document.getElementById('password_button').remove();
  document.getElementById('mobile_container').remove();

  let first = true;
  Object.getOwnPropertyNames(data).sort().forEach(
    function (val) {
      let opt = document.createElement('option');
      opt.value = val;
      opt.innerHTML = val;
      anime_select.appendChild(opt);
      if(first) {
        cur_group = val;
        first = false;
      }
    }
  );

  next_button.style.display = '';
  anime_select.style.display = '';
  song_select.style.display = '';
  quality_select.style.display = '';

  if(mobile) {
    iso_prevent_sleep = setInterval(function () {
      if(!document.hidden) {
        window.location.href = "prevent_sleep";
        window.setTimeout(function () {
            window.stop();
        }, 0);
      }
    }, 30000);
  }

  play_group(cur_group);
};
    </script>
</head>

<body>
  <video controls id='player' autoplay='true' width='640' webkit-playsinline='true' playsinline='true'></video>
  <p id='desc'></p>
  <p id='password_label'>Password:</p><input id='password_input' type="text" name="password_name">
  <button id='password_button' onclick="start()">Submit</button>
  <span id='mobile_container'>
    <input type='checkbox' id="mobile_checkbox">Mobile
  </span>
  <div style='padding-bottom: 10px'>
    <select id="anime_select" onchange="play_group(this.value)" autocomplete="off" style="display:none"></select>
    <select id="quality_select" onchange="set_quality(this.value)" autocomplete="off" style="display:none">
      <option value="mp3" selected>mp3</option>
      <option value="webm">webm</option>
    </select>
  </div>
  <div style='padding-bottom: 10px'>
    <select id="song_select" onchange="play_song(parseInt(this.value))" size="10" autocomplete="off" style="display:none; font-size:1em"></select>
  </div>
  <div>
    <button id='next_button' onclick="play_next()" style="display:none; font-size:1.5em">Next</button>
  </div>
</body>

</html>
