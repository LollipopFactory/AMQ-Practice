<!DOCTYPE html>
<html>

<head>
  <title>AMQ Listening</title>
  <meta charset='utf-8'/>
  <script src="data.js"></script>
    <script>
// this dumb bit of "encryption" is not meant to keep a determined individual
// from getting the links stored here, since it is fairly simple to crack
// however, it is enough to keep any basic web crawler from picking them up
const amq_scramble = {};

amq_scramble.hosts = {
  "catbox": "https://files.catbox.moe",
  "track9": "https://track9.mixtape.moe",
};
amq_scramble.decode_link_obj = function(link_obj, password) {
  let link = amq_scramble.hosts[link_obj.host] + '/';
  for(let i = 0; i < link_obj.code.length; i++) {
    link += String.fromCharCode(link_obj.code[i] ^ password.charCodeAt(i % password.length)); //fun
  };
  return link + '.' + link_obj.ext;
};
amq_scramble.parse_link_string = function(link_string) {
  let semi_split = link_string.split(';');
  return {
    host: semi_split[0],
    code: semi_split[1].split(',').map(x => parseInt(x)),
    ext:  semi_split[2],
  };
};
amq_scramble.decode = function(link_string, password) {
  return amq_scramble.decode_link_obj(amq_scramble.parse_link_string(link_string), password);
};

let cur_song = 0;
let cur_group = 'Ongaku Shoujo';
let quality = 'mp3';
let player = undefined;
let desc = undefined;
let anime_select = undefined;
let quality_select = undefined;
let song_select = undefined;
let password = '';

const play_song = function(index) {
  cur_song = index;
  player.src = amq_scramble.decode(data[cur_group][cur_song][quality], password);
  desc.innerHTML = data[cur_group][cur_song].desc;
};

const play_group = function(group) {
  cur_group = group;
  cur_song = 0;

  for (a in song_select.options) { song_select.options.remove(0); }

  data[cur_group].forEach(
    function (val, idx) {
      let opt = document.createElement('option');
      opt.value = idx;
      opt.innerHTML = val.desc;
      song_select.appendChild(opt);
    }
  );

  play_song(cur_song);
};

const set_quality = function(q) {
  quality = q;
  play_song(cur_song);
};

const start = function() {
  desc = document.getElementById('desc');
  password = document.getElementById('password_input').value;
  anime_select = document.getElementById('anime_select');
  song_select = document.getElementById('song_select');
  quality_select = document.getElementById('quality_select');

  player = document.getElementById('player');
  player.addEventListener('ended', function() {
    play_song((cur_song + 1) % data[cur_group].length);
  });

  document.getElementById('password_input').remove();
  document.getElementById('password_lable').remove();
  document.getElementById('password_button').remove();

  let first = true;
  Object.getOwnPropertyNames(data).forEach(
    function (val) {
      let opt = document.createElement('option');
      opt.value = val;
      opt.innerHTML = val;
      anime_select.appendChild(opt);
      if(first) {
        cur_group = val;
        first = false;
      }
    }
  );

  anime_select.style.display = '';
  song_select.style.display = '';
  quality_select.style.display = '';

  play_group(cur_group);
};
    </script>
</head>

<body>
  <video controls id='player' autoplay='true' width='640'></video>
  <p id='desc'></p>
  <p id='password_lable'>Password:</p><input id='password_input' type="text" name="password_name">
  <button id='password_button' onclick="start()">Submit</button>
  <select id="anime_select" onchange="play_group(this.value)" autocomplete="off" style="display:none"></select>
  <select id="song_select" onchange="play_song(parseInt(this.value))" autocomplete="off" style="display:none"></select>
  <select id="quality_select" onchange="set_quality(this.value)" autocomplete="off" style="display:none">
    <option value="mp3" selected>mp3</option>
    <option value="webm">webm</option>
  </select>
</body>

</html>
